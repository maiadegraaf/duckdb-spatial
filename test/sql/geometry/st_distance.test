# name: test/sql/geometry/st_distance.test
# group: [geometry]

require spatial

# This test case comes from a bug report, where the indexed point-in-polygon check would not consider that
# the second vertex of the last segment in each index node neccessarily have to be the first vertex of the next segment.
# Therefore when performing a raycast from a point to a polygon where the ray would intersect
# the segment formed by the last vertex in a index leaf node, and the first vertex in the next segment, the result
# would be incorrect.
# To test this, we create a polygon with 40 vertices, causing two index leaf nodes (0-31, 33-40) to be created when
# preparing the polygon, and we then query a point that is to the left of the polygon, but right between the segment
# spanning the two nodes (31-32).

query I
SELECT ST_Distance(
     ST_Point(-5, 31),
     -- 32 points
     ST_GeomFromText('POLYGON((
         0  0, 0  1, 0  2, 0  3, 0  4, 0  5, 0  6, 0  7,
         0  8, 0  9, 0 10, 0 11, 0 12, 0 13, 0 14, 0 15,
         0 16, 0 17, 0 18, 0 19, 0 20, 0 21, 0 22, 0 23,
         0 24, 0 25, 0 26, 0 27, 0 28, 0 29, 0 30, 0 31,
         0 32, 0 33, 0 34, 0 35, 0 36, 0 37, 0 38, 0 39,
         0 0))'));
----
5


# This test also comes from a bug report, where ST_Distance would incorrectly handle line segments with zero length.
# The issue is that we were not properly considering segments where both endpoints are the same point, and conclude
# that a zero length segment always intersects with any other segment, which is not correct. We now skip zero-length
# segments when performing intersection tests between indexed polygon rings, and also handle zero-length segments as
# points when performing regular segment-segment intersection tests.

query I
select st_distance('POLYGON((0 0, 1 1, 1 1, 10 10, 0 0))'::GEOMETRY, 'POLYGON((4 0, 4 1, 5 1, 5 0, 4 0))'::GEOMETRY) != 0;
----
true

